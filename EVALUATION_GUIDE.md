# 训练模型评估指南

## 概述

[`evaluate_trained_model.py`](evaluate_trained_model.py) 是一个全面的训练模型评估工具，用于测试训练后模型的各项性能指标和物理合理性。

## 功能特性

### 1. 自动化评估指标

脚本会自动评估以下关键指标：

#### 奖励指标
- 平均总奖励
- 平均步奖励
- 奖励范围和标准差

#### 制氢性能
- 平均制氢量 (kg/天)
- 平均电解槽功率 (kW)
- 平均运行时长 (小时/天)
- **合理性判断**：
  - ⚠️ 警告：<30 kg/天（过低）
  - ⚠️ 注意：30-50 kg/天（偏低）
  - ✓ 正常：≥50 kg/天

#### 电解槽启停分析
- 平均启动次数 (次/天)
- 平均关闭次数 (次/天)
- **合理性判断**：
  - ⚠️ 警告：>5次/天（过于频繁）
  - ⚠️ 注意：3-5次/天（较频繁）
  - ✓ 正常：≤3次/天

#### 电池性能
- 平均循环次数 (次/天)
- 平均充放电时长
- 平均电池功率 (kW)

#### 负荷满足率
- 平均负荷满足率 (%)
- **合理性判断**：
  - ⚠️ 警告：<95%（可靠性不足）
  - ⚠️ 注意：95-98%（偏低）
  - ✓ 正常：≥98%

#### 可再生能源利用
- 平均利用率 (%)
- 平均弃电率 (%)
- **合理性判断**：
  - ⚠️ 警告：弃电率>20%（过高）
  - ⚠️ 注意：弃电率10-20%（偏高）
  - ✓ 正常：弃电率≤10%

#### 物理约束检查
- SOC违规次数
- SOCH违规次数
- **合理性判断**：
  - ⚠️ 警告：存在违规（检查环境代码）
  - ✓ 正常：无违规

### 2. 可视化评估报告

自动生成9个子图的综合评估报告：

1. **(a) 奖励分布**：直方图显示奖励分布和均值
2. **(b) 制氢量分布**：直方图显示制氢量分布和均值
3. **(c) 电解槽启停次数**：柱状图对比启动/关闭次数
4. **(d) 电解槽运行时长**：折线图显示每个episode的运行时长
5. **(e) 负荷满足率**：折线图显示负荷满足率趋势
6. **(f) 弃电率**：折线图显示弃电率趋势
7. **(g) 电池循环次数分布**：直方图显示循环次数分布
8. **(h) 综合性能雷达图**：5维雷达图展示整体性能
9. **(i) 综合评分**：0-100分评分系统，包含A/B/C/D评级

### 3. 综合评分系统

**评分公式**：
```
总分 = 制氢性能(30%) + 启停控制(20%) + 负荷满足(30%) + 能源利用(20%)
```

**评级标准**：
- **A (优秀)**：≥90分
- **B (良好)**：80-89分
- **C (合格)**：70-79分
- **D (需改进)**：<70分

## 使用方法

### 基本使用

```bash
python evaluate_trained_model.py
```

默认配置：
- 模型路径：`results/ddpg_checkpoint.pth`
- 评估episodes：10个
- 输出报告：`results/evaluation_report.png`

### 自定义评估

修改 [`evaluate_trained_model.py`](evaluate_trained_model.py) 中的参数：

```python
# 修改评估episodes数量
evaluator.evaluate(num_episodes=20, verbose=True)

# 修改模型路径
evaluator = ModelEvaluator(model_path='path/to/your/model.pth')
```

## 输出解读

### 终端输出示例

```
================================================================================
  开始评估训练模型（10 episodes）
================================================================================

Episode 1/10: 奖励=3245.6, 制氢=65.3kg, 启停=2次
Episode 2/10: 奖励=3189.2, 制氢=62.8kg, 启停=3次
...

================================================================================
  评估结果摘要
================================================================================

【1. 奖励指标】
  平均总奖励: 3215.40 ± 125.30
  平均步奖励: 134.81 ± 5.25
  奖励范围: [3050.20, 3380.50]

【2. 制氢性能】
  平均制氢量: 64.20 ± 3.50 kg/天
  制氢量范围: [58.50, 70.30] kg/天
  平均电解槽功率: 2650.30 kW
  平均运行时长: 18.5 小时/天
  ✓  制氢量正常（≥50kg/天）

【3. 电解槽启停分析】
  平均启动次数: 2.30 次/天
  平均关闭次数: 2.20 次/天
  ✓  启停频率正常（≤3次/天）

【4. 电池性能】
  平均循环次数: 1.80 次/天
  平均充电时长: 1.8 小时/天
  平均电池功率: 450.20 kW

【5. 负荷满足率】
  平均负荷满足率: 99.85%
  ✓  负荷满足率正常（≥98%）

【6. 可再生能源利用】
  平均利用率: 92.50%
  平均弃电率: 7.50%
  ✓  弃电率正常（≤10%）

【7. 物理约束检查】
  SOC违规次数: 0
  SOCH违规次数: 0
  ✓  无物理约束违规

================================================================================

✓ 评估报告已保存: results/evaluation_report.png
```

### 如何根据评估结果调整

#### 情况1：制氢量过低（<30kg/天）

**问题**：Agent不愿意启动电解槽

**解决方案**：
1. 增大制氢奖励权重：
   ```python
   # 在 h2_res_env.py 的 _calculate_reward() 中
   r_h2_production = (p_el / P_EL_rated) * 40.0  # 从30改为40
   ```

2. 减小启动惩罚：
   ```python
   penalty_startup = -15.0  # 从-20改为-15
   ```

3. 增大弃电惩罚：
   ```python
   penalty_dump = (p_dump / P_total) * 20.0  # 从10改为20
   ```

#### 情况2：启停过于频繁（>5次/天）

**问题**：Agent频繁开关电解槽

**解决方案**：
1. 增大启停惩罚：
   ```python
   penalty_startup = -30.0  # 从-20改为-30
   penalty_shutdown = -25.0  # 从-15改为-25
   ```

2. 增大连续运行奖励：
   ```python
   r_el_continuity = min(continuous_hours * 3.0, 60.0)  # 从2.0改为3.0，上限从40改为60
   ```

#### 情况3：负荷满足率过低（<95%）

**问题**：系统可靠性不足

**解决方案**：
1. 增大负荷满足奖励：
   ```python
   r_load = load_satisfaction * 150.0  # 从100改为150
   ```

2. 增大缺电惩罚：
   ```python
   penalty_unmet = (p_unmet / p_load) * 300.0  # 从200改为300
   ```

#### 情况4：弃电率过高（>20%）

**问题**：可再生能源浪费严重

**解决方案**：
1. 增大弃电惩罚：
   ```python
   penalty_dump = (p_dump / P_total) * 30.0  # 从10改为30
   ```

2. 增大储能奖励：
   ```python
   r_battery_storage = (p_bat / E_bat_rated) * 20.0  # 从10改为20
   r_h2_production = (p_el / P_EL_rated) * 40.0  # 从30改为40
   ```

## 工作流程

### 完整的训练-评估-调优循环

```bash
# 1. 训练模型
python train.py

# 2. 评估模型
python evaluate_trained_model.py

# 3. 查看评估报告
# 打开 results/evaluation_report.png

# 4. 根据评估结果调整奖励函数
# 编辑 src/envs/h2_res_env.py

# 5. 删除旧模型，重新训练
del results\ddpg_checkpoint.pth
del results\training_rewards.npy
python train.py

# 6. 重复步骤2-5，直到满意
```

## 评估标准参考

### 优秀模型的典型指标

| 指标 | 优秀范围 | 良好范围 | 需改进 |
|------|---------|---------|--------|
| 制氢量 | ≥70 kg/天 | 50-70 kg/天 | <50 kg/天 |
| 启停次数 | ≤2次/天 | 2-3次/天 | >3次/天 |
| 负荷满足率 | ≥99% | 98-99% | <98% |
| 弃电率 | ≤5% | 5-10% | >10% |
| 综合评分 | ≥90分 | 80-89分 | <80分 |

### 物理约束要求（必须满足）

- ✓ SOC违规次数 = 0
- ✓ SOCH违规次数 = 0
- ✓ 电解槽功率 ≥300kW（运行时）
- ✓ 燃料电池功率 ≥30kW（运行时）

## 常见问题

### Q1: 评估报告显示"模型加载失败"

**A**: 确保已经训练过模型，且 `results/ddpg_checkpoint.pth` 存在。

### Q2: 评估结果波动很大

**A**: 这是正常的，因为每个episode的初始条件（SOC、SOCH、起始时间）是随机的。可以增加评估episodes数量（如20-50个）来获得更稳定的统计结果。

### Q3: 综合评分很低（<60分）

**A**: 说明模型训练不充分或奖励函数设计有问题。建议：
1. 检查训练是否收敛（查看 `results/training_rewards.npy`）
2. 增加训练episodes（如从10000增加到20000）
3. 根据评估报告的具体问题调整奖励函数

### Q4: 物理约束违规

**A**: 这是严重问题，说明环境代码有bug。检查：
1. [`h2_res_env.py`](src/envs/h2_res_env.py) 中的约束检查逻辑
2. 动作空间的裁剪是否正确
3. 状态更新是否正确

## 文件说明

- [`evaluate_trained_model.py`](evaluate_trained_model.py)：评估脚本主文件
- [`results/evaluation_report.png`](results/evaluation_report.png)：自动生成的可视化报告
- [`results/ddpg_checkpoint.pth`](results/ddpg_checkpoint.pth)：训练好的模型文件

## 相关文件

- [`train.py`](train.py)：训练脚本
- [`src/envs/h2_res_env.py`](src/envs/h2_res_env.py)：环境和奖励函数定义
- [`advanced_visualization.py`](advanced_visualization.py)：详细的可视化分析
- [`test_reward_simple.py`](test_reward_simple.py)：奖励函数单元测试

## 总结

[`evaluate_trained_model.py`](evaluate_trained_model.py) 提供了一个系统化的方法来评估训练模型的性能，帮助你：

1. ✓ 快速识别模型的优缺点
2. ✓ 量化各项性能指标
3. ✓ 获得明确的调优方向
4. ✓ 追踪训练进度和改进效果

**建议在每次重新训练后都运行此评估脚本，以确保模型性能持续改进！**